name: Build Artifacts

on:
  push:
    branches:
      - main

jobs:

  build_artifacts:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 'Autenticar-se amb Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GOOGLE_CLOUD_KEY_FILE }}'

      - name: Trobar el tag de la versio (v.x.x.x)
        id: extract_tag
        run: |
          IMAGE="europe-southwest1-docker.pkg.dev/rosepetal-dev/rosepetal-dep/rosepetal-dep-ajenti"
          digest=$(gcloud artifacts docker tags list "$IMAGE" | grep latest | awk '{print $3}')
          if [[ -z "$digest" ]]; then
            echo "Encara no hi ha cap imatge penjada"
            echo "tag=v.1.0.0" >> $GITHUB_OUTPUT
          else
            echo "Digest: $digest"

            echo "Looking for version tag(s) matching this digest..."
            version_tag=$(gcloud artifacts docker tags list "$IMAGE"| grep "$digest" | grep '^v\.' | awk '{print $1}')
            if [[ -z "$version_tag" ]]; then
              echo "Existing image with no v.x.x.x tag. Check Artifacts repository. Abording..."
              exit 1
            fi
            echo "tag=$version_tag" >> $GITHUB_OUTPUT
          fi
      - name: Enviar la construcci√≥ a Google Cloud Build
        run: gcloud builds submit . --config=cloudbuild.yaml --substitutions=_TAG=${{ steps.extract_tag.outputs.tag }}
